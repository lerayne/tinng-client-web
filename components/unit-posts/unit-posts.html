<link rel="import" href="../unit-base/unit-base.html">
<!--<link rel="import" href="../card-post/card-post.html">-->
<!--<link rel="import" href="../nodelist-posts/nodelist-posts.html">-->

<dom-module is="unit-posts"  on-load-more="{{ loadMore }}">

	<link rel="import" type="css" href="../unit-base/unit-base.css">

	<style>
		:host {

		}

		paper-toolbar, paper-toolbar::shadow .toolbar-tools {
			height: 56px;
		}

		.editor {
			background-color: #fff;
			padding: 20px;
		}

		textarea {
			margin-right: 20px;
			font-size: 150%;
			padding: 5px;
		}

		.send {
			width: 100px
		}

		polyfill-next-selector {
			content: 'block-user .name'
		}

		block-user::shadow .name {
			display: none;
		}

		polyfill-next-selector {
			content: 'block-user .avatar'
		}

		block-user::shadow .avatar {
			height: 30px;
		}

		.allowed-users {
			opacity: 1;
			transition: opacity 0.18s ease-in;
			height: 56px;
		}

		.allowed-users[hidden] {
			opacity: 0;
			/*display: flex !important;*/
		}
	</style>

	<template>

		<iron-signals
				on-iron-signal-secondary-close="meSingle"
				on-iron-signal-topic-select="topicSelect"
				on-iron-signal-add-message="addMessage"
				on-iron-signal-rescribe-all="subscribe"
				></iron-signals>

		<unit-posts-deco>
			<paper-toolbar class="[[getToolbarClass(private)]]">

				<paper-icon-button hidden$="[[ !fullframe ]]" on-tap="goBack" icon="arrow-back"></paper-icon-button>
				<!--<paper-icon-button icon="menu"></paper-icon-button>-->

				<span class="flex">
					<span id="topicName" class="name-container" contenteditable$="[[ renameMode ]]">[[topic.topic_name]]</span>
				</span>

				<paper-icon-button icon="create" hidden$="[[ !showRenameButton(rights.canRename, renameMode) ]]" on-tap="rename"></paper-icon-button>
				<paper-icon-button icon="check-circle" hidden$="[[ !renameMode ]]" on-tap="saveName"></paper-icon-button>
				<paper-icon-button icon="cancel" hidden$="[[ !renameMode ]]" on-tap="cancelRename"></paper-icon-button>


				<div hidden$="[[!private]]" class="bottom allowed-users flex vertical layout">
					<text-string hidden$="[[!private]]" class="block tinytext">unit.posts.privateDisclaimer</text-string>
					<div class="flex horizontal layout center">
						<template is="dom-repeat" items="[[topic.private]]">
							<block-user data='[[ {"name":"reader.display_name", "avatar":"reader.avatar"} ]]'></block-user>
						</template>
					</div>
				</div>

			</paper-toolbar>

			<nodelist-posts id="postsList" updates="{{updates}}" topic="{{selectedTopic}}" class="content flex"></nodelist-posts>

			<div class="editor horizontal layout">
				<textarea id="messageInput" class="flex"></textarea>
				<paper-button raised class="highlight send self-center" on-tap="addMessage">
					<text-string>unit.posts.sendBtn</text-string>
					<iron-icon icon="send"></iron-icon>
				</paper-button>
			</div>

		</unit-posts-deco>

	</template>
</dom-module>

<script>
	Polymer({
		is:'unit-posts',

		//properties
		fullframe: false,
		selectedTopic: 0,
		postsPerSlice:50,
		currentSliceTop: 0,

		//polymer
		properties:{
			selectedTopic:{
				observer:'subscribe'
			},

			private:{
				type:Boolean,
				value:false,
				computed:'isTopicPrivate(topic.private)'
			}
		},

		isTopicPrivate:function(privat){
			return typeof privat != 'undefined' && !!privat && privat != "0"
		},

		getToolbarClass:function(privat){
			return 'paper-narrow' + (privat ? 'medium-tall' : '')
		},

		showRenameButton:function(haveRight, allreadyRenaming){
			return haveRight && !allreadyRenaming;
		},


		ready: function () {
			Polymer.dom(this).classList.add('vertical', 'layout');

			this.initVars();

			if (tinng.router.get('topic')) {
				this.selectedTopic = _.parseInt(tinng.router.get('topic'));
			}
		},

		//other

		initVars:function(){
			this.updates = [];
			this.topic = {};
			this.rights = {canRename: false};
			this.currentSliceTop = this.postsPerSlice;
		},

		clean: function () {
			this.initVars();

			this.$.postsList.clean();
			tinng.router.note('topic', null);
			tinng.router.note('start', null);

			tinng.connection.unscribe(this, 'posts-main');
			tinng.connection.unscribe(this, 'topic-data-main');
		},

		subscribe: function () {
			this.clean();

			//todo - raw way
			tinng.router.note('topic', this.selectedTopic);

			tinng.connection.subscribe([{
				subscriber: this,
				feedName: 'posts-main',
				feed: {
					feed: 'posts',
					limit: this.currentSliceTop,
					topic: this.selectedTopic
				},
				parser: function (data) {
					this.updates = data;
				}
			}, {
				subscriber: this,
				feedName: 'topic-data-main',
				feed: {
					feed: 'topic',
					id: this.selectedTopic
				},
				parser: function (data) {
					this.topic = data;
					// todo - set rights for topic here
					// right now user.id is filled after topic load, so rename is unable on startup. THIS IS FINE!
					// 'cause rigts should come from server, not be computed from existing data math
					if (tinng.user){
						this.rights.canRename = (tinng.user.id == this.topic.author_id || tinng.user.id == 1);
					}
					this.fire('iron-signal', {name: 'topic-loaded', data: {id: data.id}});
				}
			}]);

			this.$.postsList.showLoading();
		},

		loadMore:function(){
			// todo - bug: sometimes loads wrong amount
			tinng.connection.rescribe(this, 'posts-main', {
				limit: this.currentSliceTop += this.postsPerSlice
			});
			tinng.router.note('start', this.currentSliceTop);
		},

		topicSelect: function (event, details) {

			this.loading = true;

			this.selectedTopic = details.topic.id;
		},

		addMessage: function (event, message) {
			var message = this.$.messageInput.value;

			if (!!this.selectedTopic && !message.match(/^\s*$/)) {

				tinng.connection.write({
					action: 'add_post',
					topic: this.selectedTopic,
					message: message
				});

				this.$.messageInput.value = '';
			}
		},

		//draft
		meSingle: function () {
			this.fullframe = true;
		},

		goBack: function () {

			this.async(function () {
				this.fullframe = false;
			}, null, 250);

			this.fire('reveal', {sender: this})
		},

		unlock:function(){
			tinng.connection.query('service', null, {
				action:'unlock_message',
				id: this.selectedTopic
			})
		},


		checkAndLock:function(callback){
			tinng.connection.query('service', callback.bind(this), {
				action: 'check_n_lock',
				id: this.selectedTopic
			});
		},

		rename: function () {
			this.checkAndLock(function(){
				this.oldName = this.topic.topic_name;
				this.renameMode = true;
			});
		},

		cancelRename: function () {
			this.unlock();
			// todo - lurk mutation observer or wait for polymer to implement contenteditable feature
			this.$.topicName.innerText = this.oldName;
			this.renameMode = false;
		},

		saveName: function () {
			this.unlock();
			this.renameMode = false;

			tinng.connection.write({
				action: 'update_message',
				topic_name: this.$.topicName.innerText,
				id: this.selectedTopic
			});
		}
	});
</script>
