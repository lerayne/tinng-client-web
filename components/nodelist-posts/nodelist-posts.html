<link rel="import" href="../nodelist-base/nodelist-base.html">

<polymer-element name="nodelist-posts" extends="nodelist-base">
	<template>

		<style>
			#scroll {
				padding: 15px 5px 1px 15px;
			}

			#loadMore {
				margin-bottom:8px;
				padding:2px 0;
				cursor:pointer;
				text-align: center;
			}

			#loadMore:hover {
				background-color: #ddd;
			}
		</style>

		<div id="scroll">
			<div id="loadMore" hidden?="{{ !loadMore }}">
				<text-string>unit.posts.loadMore</text-string>
			</div>

			<template repeat="{{ node in nodes }}">
				<card-post model="{{ node }}"></card-post>
			</template>
		</div>

	</template>

	<script>
		Polymer({

			//properties
			sortOrder:'asc',
			headLoaded:false,

			//polymer
			computed:{
				loadMore:'nodes.length && !headLoaded'
			},

			//other
			parseUpdates:function(old, nodes){

				var firstLoad = !this.nodes.length;

				if (firstLoad) {
					// если это первичная загрузка

					this.headLoaded = false;

					console.log('nodes', this.topic, _(nodes).find({id:this.topic}))

					if (typeof _(nodes).find({id:this.topic}) != 'undefined'){
						console.log('topic head loaded');
						this.headLoaded = true;
					}

					// если мы заполняем массив первый раз - нужно его отсортировать
					this.nodes = this.sort(nodes, this.sortField, this.sortOrder);

				} else {
					// если в массиве уже есть ноды
					_(nodes).each(this.processNode);
				}

				if (firstLoad || this.isAtBottom()) {
					this.async(this.toBottom)
				}

				this.loaded = true;
				this.loading = false;
			},

			processNode:function(data){
				//console.log(data.id, this.topic);

				if (data.id == this.topic){
					console.log('topic head loaded')
					this.headLoaded = true;
				}

				this.super(arguments);
			},

			showLoading:function(){
				this.loaded = false;
				this.loading = true;
			}
		})
	</script>
</polymer-element>