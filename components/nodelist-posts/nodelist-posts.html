<link rel="import" href="../nodelist-base/nodelist-base.html">

<polymer-element name="nodelist-posts" extends="nodelist-base">
	<template>

		<style>
			#scroll {
				padding: 15px 5px 1px 15px;
				position: relative;
			}

			#loadMore {
				margin-bottom:8px;
			}

			#loadMore text-string {
				text-align: center;
				display: block;
				padding:2px 0;
			}

			.loadMoreBtn {
				cursor:pointer;
			}

			.loadMoreBtn:hover {
				background-color: #ddd;
			}
		</style>

		<div id="scroll">
			<div id="loadMore" hidden?="{{ !loadMoreBtn }}">
				<text-string class="loadMoreBtn" on-tap="{{ loadMore }}" hidden?="{{loading}}">unit.posts.loadMore</text-string>
				<text-string hidden?="{{!loading}}">unit.posts.loading</text-string>
			</div>

			<template repeat="{{ node in nodes }}">
				<card-post model="{{ node }}"></card-post>
			</template>
		</div>

	</template>

	<script>
		Polymer({

			//properties
			sortOrder:'asc',
			headLoaded:false,

			//polymer
			computed:{
				loadMoreBtn:'nodes.length && !headLoaded'
			},

			//other
			parseUpdates:function(old, nodes){

				var firstLoad = !this.nodes.length;
				var wasAtTop = this.isAtTop();

				if (!firstLoad && wasAtTop) {
					var topPost = $(this.$.scroll).children('card-post').eq(0);
					var topOffset = topPost[0].offsetTop;

					console.log(topPost, topOffset)
				}

				if (firstLoad) {
					// если это первичная загрузка

					this.headLoaded = false;

					//console.log('nodes', this.topic, _(nodes).find({id:this.topic}))

					if (typeof _(nodes).find({id:this.topic}) != 'undefined'){
						console.log('topic head loaded');
						this.headLoaded = true;
					}

					// если мы заполняем массив первый раз - нужно его отсортировать
					this.nodes = this.sort(nodes, this.sortField, this.sortOrder);

				} else {
					// если в массиве уже есть ноды
					_(nodes).each(this.processNode);
				}

				if (firstLoad || this.isAtBottom()) {
					this.async(this.toBottom)
				}

				if (!firstLoad && wasAtTop) {
					this.async(function(){
						topPost[0].scrollIntoView();
						this.scrollTop = this.scrollTop - topOffset;
					})
				}

				this.loaded = true;
				this.loading = false;
			},

			processNode:function(data){
				//console.log(data.id, this.topic);

				if (data.id == this.topic){
					console.log('topic head loaded')
					this.headLoaded = true;
				}

				this.super(arguments);
			},

			showLoading:function(){
				this.loaded = false;
				this.loading = true;
			},

			loadMore:function(){
				this.fire('load-more');
				this.showLoading();
			}
		})
	</script>
</polymer-element>